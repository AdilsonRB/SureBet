<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculadora Surebet Profissional</title>
  <style>
    /* ======= LAYOUT ORIGINAL ======= */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }
    /* Cabe√ßalho para informa√ß√µes do usu√°rio */
    #user-info {
      text-align: right;
      margin-bottom: 20px;
      display: none;
    }
    #user-info span {
      font-weight: bold;
      margin-right: 10px;
    }
    #user-info button {
      padding: 5px 10px;
      font-size: 0.9em;
      background: #e74c3c;
      border: none;
      color: #fff;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    #user-info button:hover {
      background: #c0392b;
    }
    /* Container principal com layout original */
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      margin-bottom: 30px;
    }
    h2, h3 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .input-group {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    .input-container {
      flex: 1;
      position: relative;
      min-width: 250px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      color: #34495e;
      font-weight: 600;
      font-size: 0.95em;
    }
    input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: #f8f9fa;
    }
    input:focus {
      outline: none;
      border-color: #3498db;
      background: white;
      box-shadow: 0 0 8px rgba(52, 152, 219, 0.2);
    }
    .results {
      margin-top: 25px;
      padding: 20px;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    .result-item {
      margin: 15px 0;
      font-size: 1.1em;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }
    .result-item:last-child {
      border-bottom: none;
    }
    .result-item span {
      font-weight: 700;
      font-size: 1.2em;
    }
    #total-invested span { color: #2980b9; }
    #profit-amount { color: #27ae60; }
    #profit-percentage { color: #e67e22; }
    .actions {
      margin-top: 25px;
      text-align: center;
    }
    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.3s ease;
      margin-top: 20px;
    }
    button:hover {
      background: #2980b9;
      transform: translateY(-1px);
    }
    .loading {
      display: none;
      text-align: center;
      color: #3498db;
      margin: 15px 0;
    }
    #error-message {
      color: #e74c3c;
      background: #f8d7da;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      display: none;
    }
    #success-message {
      color: #27ae60;
      margin-top: 15px;
      display: none;
    }
    .currency {
      position: absolute;
      right: 15px;
      top: 38px;
      color: #7f8c8d;
      font-weight: 500;
    }
    /* Se√ß√£o de Hist√≥rico com o mesmo estilo do container principal */
    .history {
      max-width: 600px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      overflow-x: auto;  /* permite rolagem horizontal se necess√°rio */
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
      min-width: 700px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 10px;
      text-align: center;
    }
    th {
      background: #3498db;
      color: #fff;
    }
    #date-filter {
      margin-bottom: 15px;
      padding: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <!-- Cabe√ßalho com informa√ß√µes do usu√°rio -->
  <div id="user-info">
    <span id="user-name"></span>
    <button id="sign-out">Sair</button>
  </div>

  <!-- Container da Calculadora e Login -->
  <div class="container" id="calculator-container">
    <h2>üìä Calculadora Surebet</h2>
    
    <!-- Bot√£o de Login com Google -->
    <div class="actions">
      <button id="google-login">Login com Google</button>
    </div>
    
    <div id="error-message"></div>

    <!-- ====== CAMPOS DE INPUT ====== -->
    <div class="input-group">
      <div class="input-container">
        <label for="odd1">Odd 1</label>
        <input type="number" step="0.01" id="odd1" placeholder="Ex: 1.80">
      </div>
      <div class="input-container">
        <label for="odd2">Odd 2</label>
        <input type="number" step="0.01" id="odd2" placeholder="Ex: 2.20">
      </div>
    </div>

    <div class="input-group">
      <div class="input-container">
        <label for="stake1">Valor Aposta 1</label>
        <div class="currency">R$</div>
        <input type="number" step="0.01" id="stake1" placeholder="0.00">
      </div>
      <div class="input-container">
        <label for="stake2">Valor Aposta 2</label>
        <div class="currency">R$</div>
        <input type="number" step="0.01" id="stake2" placeholder="0.00">
      </div>
    </div>

    <div class="input-group">
      <div class="input-container">
        <label for="bookmaker">Casa de Aposta</label>
        <input type="text" id="bookmaker" placeholder="Ex: Bet365">
      </div>
    </div>

    <!-- ====== RESULTADOS ====== -->
    <div class="results">
      <div class="result-item" id="total-invested">
        Total Investido: <span>0.00</span>
      </div>
      <div class="result-item">
        Lucro Garantido: <span id="profit-amount">0.00</span>
      </div>
      <div class="result-item">
        ROI (%): <span id="profit-percentage">0.00%</span>
      </div>
    </div>

    <!-- BOT√ÉO SALVAR -->
    <div class="actions">
      <button id="save-bet">Salvar Aposta</button>
      <div id="loading" class="loading">Salvando...</div>
      <div id="success-message">‚úî Aposta registrada com sucesso!</div>
    </div>
  </div>

  <!-- Se√ß√£o de Hist√≥rico de Apostas -->
  <div class="history" id="history-section" style="display: none;">
    <h3>Hist√≥rico de Apostas</h3>
    <div class="actions">
      <select id="date-filter">
        <option value="all">Todos</option>
        <option value="24h">√öltimas 24 horas</option>
        <option value="48h">√öltimas 48 horas</option>
        <option value="7d">√öltimos 7 dias</option>
        <option value="30d">√öltimos 30 dias</option>
      </select>
    </div>

    <table id="bet-history-table">
      <thead>
        <tr>
          <th>Data/Hora</th>
          <th>Casa de Aposta</th>
          <th>Odd 1</th>
          <th>Odd 2</th>
          <th>Stake 1</th>
          <th>Stake 2</th>
          <th>Total Investido</th>
          <th>Lucro</th>
          <th>ROI (%)</th>
        </tr>
      </thead>
      <tbody><!-- Carregado em tempo real --></tbody>
    </table>

    <div class="actions">
      <button id="export-csv">Exportar CSV</button>
    </div>
  </div>

  <!-- SCRIPT PRINCIPAL -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      addDoc,
      query,
      where,
      onSnapshot,
      orderBy
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { 
      getAuth, 
      signInWithPopup, 
      GoogleAuthProvider,
      onAuthStateChanged,
      setPersistence,
      browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // ====== CONFIGURA√á√ÉO FIREBASE ======
    const firebaseConfig = {
      apiKey: "AIzaSyCKEdVxlZ7QZCKzwMWwTjvJw6gkWBPU1Ks",
      authDomain: "surebet-8alac.firebaseapp.com",
      projectId: "surebet-8alac",
      storageBucket: "surebet-8alac.appspot.com",
      messagingSenderId: "356453418095",
      appId: "1:356453418095:web:b5fa12af09432b9676b99a"
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Persist√™ncia local
    await setPersistence(auth, browserLocalPersistence);

    // ====== Elementos da interface ======
    const elements = {
      odd1: document.getElementById('odd1'),
      odd2: document.getElementById('odd2'),
      stake1: document.getElementById('stake1'),
      stake2: document.getElementById('stake2'),
      totalInvested: document.querySelector('#total-invested span'),
      profitPercentage: document.getElementById('profit-percentage'),
      profitAmount: document.getElementById('profit-amount'),
      saveButton: document.getElementById('save-bet'),
      loading: document.getElementById('loading'),
      errorMessage: document.getElementById('error-message'),
      successMessage: document.getElementById('success-message'),
      googleLoginButton: document.getElementById('google-login'),
      bookmaker: document.getElementById('bookmaker'),
      dateFilter: document.getElementById('date-filter')
    };
    const userInfo = document.getElementById('user-info');
    const userName = document.getElementById('user-name');
    const signOutButton = document.getElementById('sign-out');
    const historySection = document.getElementById('history-section');

    let currentUser = null;       // usu√°rio logado
    let unsubscribeHistory = null; // para parar o onSnapshot antigo quando mudar o filtro

    // Observador de autentica√ß√£o
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        console.log('Usu√°rio autenticado:', currentUser.displayName);
        userName.textContent = currentUser.displayName || "Usu√°rio";
        userInfo.style.display = 'block';
        elements.googleLoginButton.style.display = 'none';
        historySection.style.display = 'block';
        // Carrega hist√≥rico inicial
        loadBetHistory(currentUser.uid, 'all');
      } else {
        currentUser = null;
        userInfo.style.display = 'none';
        elements.googleLoginButton.style.display = 'block';
        historySection.style.display = 'none';
      }
    });

    // LOGOUT
    signOutButton.addEventListener('click', async () => {
      try {
        await auth.signOut();
        console.log("Usu√°rio deslogado!");
      } catch (error) {
        console.error("Erro ao sair:", error);
      }
    });

    // ====== C√°lculo Surebet ======
    function calculateProfit() {
      const o1 = parseFloat(elements.odd1.value);
      const o2 = parseFloat(elements.odd2.value);
      const s1 = parseFloat(elements.stake1.value) || 0;
      const s2 = parseFloat(elements.stake2.value) || 0;

      const total = s1 + s2;
      elements.totalInvested.textContent = total.toFixed(2);

      let profitPct = 0, profitAmt = 0;
      if (o1 > 0 && o2 > 0) {
        const totImpl = (1/o1 + 1/o2);
        if (totImpl < 1) {
          profitPct = ((1 / totImpl) - 1) * 100;
          profitAmt = total * (profitPct / 100);
        }
      }
      elements.profitPercentage.textContent = profitPct.toFixed(2) + '%';
      elements.profitAmount.textContent = profitAmt.toFixed(2);
    }

    // Recalcula stake ao mudar a odd
    function calculateStakes() {
      const o1 = parseFloat(elements.odd1.value);
      const o2 = parseFloat(elements.odd2.value);
      if (o1 > 0 && o2 > 0) {
        const total = parseFloat(elements.stake1.value) + parseFloat(elements.stake2.value);
        if (total > 0) {
          elements.stake1.value = ((total * o2) / (o1 + o2)).toFixed(2);
          elements.stake2.value = ((total * o1) / (o1 + o2)).toFixed(2);
        }
      }
      calculateProfit();
    }

    elements.odd1.addEventListener('input', calculateStakes);
    elements.odd2.addEventListener('input', calculateStakes);

    elements.stake1.addEventListener('input', () => {
      handleStakeInput(elements.stake1, elements.stake2,
        parseFloat(elements.odd1.value),
        parseFloat(elements.odd2.value)
      );
    });
    elements.stake2.addEventListener('input', () => {
      handleStakeInput(elements.stake2, elements.stake1,
        parseFloat(elements.odd2.value),
        parseFloat(elements.odd1.value)
      );
    });

    function handleStakeInput(inp, other, oddI, oddO) {
      const val = parseFloat(inp.value);
      if (oddI > 0 && oddO > 0 && !isNaN(val)) {
        other.value = ((val * oddI) / oddO).toFixed(2);
      }
      calculateProfit();
    }

    // ====== Carregar Hist√≥rico ======
    function loadBetHistory(uid, filter) {
      // se j√° houver um onSnapshot ativo, paramos para n√£o duplicar
      if (unsubscribeHistory) {
        unsubscribeHistory();
      }
      const betsRef = collection(db, 'bets');
      // query base
      let betsQuery = query(
        betsRef,
        where('uid', '==', uid),
        orderBy('timestamp','desc')
      );

      if (filter !== 'all') {
        const now = new Date();
        const startDate = new Date();
        if (filter === '24h') {
          startDate.setHours(now.getHours() - 24);
        } else if (filter === '48h') {
          startDate.setHours(now.getHours() - 48);
        } else if (filter === '7d') {
          startDate.setDate(now.getDate() - 7);
        } else if (filter === '30d') {
          startDate.setDate(now.getDate() - 30);
        }
        betsQuery = query(
          betsRef,
          where('uid','==',uid),
          // Filtra os docs cujo timestamp >= startDate.toISOString()
          where('timestamp','>=', startDate.toISOString()),
          orderBy('timestamp','desc')
        );
      }

      console.log("[loadBetHistory] Iniciando onSnapshot...");
      unsubscribeHistory = onSnapshot(betsQuery, (snapshot) => {
        console.log("[loadBetHistory] snapshot size:", snapshot.size);
        const tbody = document.querySelector('#bet-history-table tbody');
        tbody.innerHTML = "";
        snapshot.forEach(doc => {
          const data = doc.data();
          console.log("[loadBetHistory] docId:", doc.id, " data:", data);

          // 'timestamp' √© string ISO => "2025-03-15T12:34:56.789Z"
          const dateObj = new Date(data.timestamp);
          // Ajusta para hor√°rio de Bras√≠lia (ou outro fuso)
          const dateStr = dateObj.toLocaleString("pt-BR", {
            timeZone: "America/Sao_Paulo"
          });

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${dateStr}</td>
            <td>${data.bookmaker || ''}</td>
            <td>${data.odd1.toFixed(2)}</td>
            <td>${data.odd2.toFixed(2)}</td>
            <td>${data.stake1.toFixed(2)}</td>
            <td>${data.stake2.toFixed(2)}</td>
            <td>${data.total.toFixed(2)}</td>
            <td>${data.lucro.toFixed(2)}</td>
            <td>${data.roi.toFixed(2)}%</td>
          `;
          tbody.appendChild(tr);
        });
      }, (error) => {
        console.error("[loadBetHistory] Erro onSnapshot:", error);
        elements.errorMessage.textContent = "Erro ao carregar hist√≥rico: " + error.message;
        elements.errorMessage.style.display = 'block';
      });
    }

    // Ao mudar o filtro
    elements.dateFilter.addEventListener('change', (event) => {
      if (currentUser) {
        loadBetHistory(currentUser.uid, event.target.value);
      }
    });

    // ====== Exportar CSV ======
    document.getElementById('export-csv').addEventListener('click', () => {
      exportTableToCSV('historico_apostas.csv');
    });
    function exportTableToCSV(filename) {
      const csv = [];
      const rows = document.querySelectorAll("#bet-history-table tr");
      rows.forEach(row => {
        const cols = row.querySelectorAll("td, th");
        const rowData = [];
        cols.forEach(col => {
          rowData.push('"' + col.innerText.replace(/"/g, '""') + '"');
        });
        csv.push(rowData.join(","));
      });
      const csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
      const downloadLink = document.createElement("a");
      downloadLink.download = filename;
      downloadLink.href = window.URL.createObjectURL(csvFile);
      downloadLink.style.display = "none";
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
    }

    // ====== Salvar Aposta ======
    elements.saveButton.addEventListener('click', async () => {
      if (!currentUser) {
        elements.errorMessage.textContent = "Por favor, fa√ßa login antes de salvar a aposta.";
        elements.errorMessage.style.display = 'block';
        return;
      }
      console.log("[save-bet] Iniciando salvamento...");
      elements.loading.style.display = 'block';
      elements.errorMessage.style.display = 'none';
      try {
        const nowISO = new Date().toISOString();
        const betData = {
          uid: currentUser.uid,
          odd1: parseFloat(elements.odd1.value),
          odd2: parseFloat(elements.odd2.value),
          stake1: parseFloat(elements.stake1.value),
          stake2: parseFloat(elements.stake2.value),
          total: parseFloat(elements.totalInvested.textContent),
          lucro: parseFloat(elements.profitAmount.textContent),
          roi: parseFloat(elements.profitPercentage.textContent.replace('%','')),
          bookmaker: elements.bookmaker.value || "",
          timestamp: nowISO // <-- String ISO para evitar datas 1970
        };
        console.log("[save-bet] Enviando betData =>", betData);
        const docRef = await addDoc(collection(db, 'bets'), betData);
        console.log("[save-bet] Salvo com docId:", docRef.id);

        elements.successMessage.style.display = 'block';
        setTimeout(() => {
          elements.successMessage.style.display = 'none';
        }, 3000);
      } catch (err) {
        console.error("[save-bet] Erro =>", err);
        elements.errorMessage.textContent = `Erro: ${err.message}`;
        elements.errorMessage.style.display = 'block';
      } finally {
        console.log("[save-bet] Fim do salvamento.");
        elements.loading.style.display = 'none';
      }
    });

    // ====== Login com Google ======
    elements.googleLoginButton.addEventListener('click', async () => {
      console.log("[login] Tentando login com Google...");
      try {
        await signInWithPopup(auth, provider);
        console.log("[login] Login Google bem-sucedido!");
      } catch (error) {
        console.error("[login] Erro =>", error);
        elements.errorMessage.textContent = `Erro no login: ${error.message}`;
        elements.errorMessage.style.display = 'block';
      }
    });

    // Inicia os c√°lculos com zero
    calculateProfit();
  </script>
</body>
</html>
