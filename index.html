<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora Surebet Profissional</title>
  <style>
    /* [Mantenha os estilos anteriores sem alteraÃ§Ãµes] */
  </style>
</head>
<body>
  <!-- Container de Login e Calculadora -->
  <div class="container" id="calculator-container">
    <h2>ðŸ“Š Calculadora Surebet</h2>
    
    <!-- BotÃ£o de Login com Google -->
    <div class="actions">
      <button id="google-login">Login com Google</button>
    </div>
    
    <div id="error-message"></div>

    <div class="input-group">
      <div class="input-container">
        <label for="odd1">Odd 1</label>
        <input type="number" step="0.01" id="odd1" placeholder="Ex: 1.80">
      </div>
      <div class="input-container">
        <label for="odd2">Odd 2</label>
        <input type="number" step="0.01" id="odd2" placeholder="Ex: 2.20">
      </div>
    </div>

    <div class="input-group">
      <div class="input-container">
        <label for="stake1">Valor Aposta 1</label>
        <div class="currency">R$</div>
        <input type="number" step="0.01" id="stake1" placeholder="0.00">
      </div>
      <div class="input-container">
        <label for="stake2">Valor Aposta 2</label>
        <div class="currency">R$</div>
        <input type="number" step="0.01" id="stake2" placeholder="0.00">
      </div>
    </div>

    <div class="results">
      <div class="result-item" id="total-invested">
        Total Investido: <span>0.00</span>
      </div>
      <div class="result-item">
        Lucro Garantido: <span id="profit-amount">0.00</span>
      </div>
      <div class="result-item">
        ROI (%): <span id="profit-percentage">0.00%</span>
      </div>
    </div>

    <div class="actions">
      <button id="save-bet">Salvar Aposta</button>
      <div id="loading" class="loading">Salvando...</div>
      <div id="success-message">âœ” Aposta registrada com sucesso!</div>
    </div>
  </div>

  <!-- SeÃ§Ã£o de HistÃ³rico de Apostas -->
  <div class="history" id="history-section" style="display: none;">
    <h3>HistÃ³rico de Apostas</h3>
    <table id="bet-history-table">
      <thead>
        <tr>
          <th>Data</th>
          <th>Odd 1</th>
          <th>Odd 2</th>
          <th>Stake 1</th>
          <th>Stake 2</th>
          <th>Total Investido</th>
          <th>Lucro</th>
          <th>ROI (%)</th>
        </tr>
      </thead>
      <tbody>
        <!-- Linhas geradas dinamicamente -->
      </tbody>
    </table>
    <div class="actions">
      <button id="export-csv">Exportar CSV</button>
    </div>
  </div>

  <!-- Script com integraÃ§Ã£o Firebase, login, cÃ¡lculos, histÃ³rico e exportaÃ§Ã£o CSV -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      addDoc,
      query,
      where,
      getDocs,
      onSnapshot
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { 
      getAuth, 
      signInWithPopup, 
      GoogleAuthProvider,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // ConfiguraÃ§Ã£o do Firebase (substitua com suas credenciais)
    const firebaseConfig = {
      apiKey: "AIzaSyCKEdVxlZ7QZCKzwMWwTjvJw6gkWBPU1Ks",
      authDomain: "surebet-8a1ac.firebaseapp.com",
      projectId: "surebet-8a1ac",
      storageBucket: "surebet-8a1ac.firebasestorage.app",
      messagingSenderId: "356453418095",
      appId: "1:356453418095:web:b5fa12af09432b9676b99a",
      measurementId: "G-WYX4MDS2F8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Elementos da interface
    const elements = {
      odd1: document.getElementById('odd1'),
      odd2: document.getElementById('odd2'),
      stake1: document.getElementById('stake1'),
      stake2: document.getElementById('stake2'),
      totalInvested: document.querySelector('#total-invested span'),
      profitPercentage: document.getElementById('profit-percentage'),
      profitAmount: document.getElementById('profit-amount'),
      saveButton: document.getElementById('save-bet'),
      loading: document.getElementById('loading'),
      errorMessage: document.getElementById('error-message'),
      successMessage: document.getElementById('success-message'),
      googleLoginButton: document.getElementById('google-login')
    };

    let currentUser = null; // Armazena o usuÃ¡rio logado

    // Observador de estado de autenticaÃ§Ã£o
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        console.log('UsuÃ¡rio autenticado:', currentUser.displayName);
        // Oculta o botÃ£o de login e exibe a seÃ§Ã£o de histÃ³rico
        elements.googleLoginButton.style.display = 'none';
        document.getElementById('history-section').style.display = 'block';
        // Carrega o histÃ³rico (vocÃª pode usar um listener em tempo real)
        loadBetHistory(currentUser.uid);
      } else {
        currentUser = null;
        elements.googleLoginButton.style.display = 'block';
        document.getElementById('history-section').style.display = 'none';
      }
    });

    // FunÃ§Ãµes de CÃ¡lculo
    function calculateStakes() {
      const o1 = parseFloat(elements.odd1.value);
      const o2 = parseFloat(elements.odd2.value);
      
      if(o1 > 0 && o2 > 0) {
        const total = parseFloat(elements.stake1.value) + parseFloat(elements.stake2.value);
        if(total > 0) {
          elements.stake1.value = ((total * o2) / (o1 + o2)).toFixed(2);
          elements.stake2.value = ((total * o1) / (o1 + o2)).toFixed(2);
        }
      }
      calculateProfit();
    }

    function handleStakeInput(inputElement, otherElement, odd1, odd2) {
      const value = parseFloat(inputElement.value);
      if(odd1 > 0 && odd2 > 0 && !isNaN(value)) {
        otherElement.value = ((value * odd1) / odd2).toFixed(2);
      }
      calculateProfit();
    }

    function calculateProfit() {
      const o1 = parseFloat(elements.odd1.value);
      const o2 = parseFloat(elements.odd2.value);
      const s1 = parseFloat(elements.stake1.value) || 0;
      const s2 = parseFloat(elements.stake2.value) || 0;
      
      const totalInvestment = s1 + s2;
      elements.totalInvested.textContent = totalInvestment.toFixed(2);

      let profitPercentage = 0;
      let profitAmount = 0;
      
      if(o1 > 0 && o2 > 0) {
        const totalImplied = (1/o1 + 1/o2);
        if(totalImplied < 1) {
          profitPercentage = ((1 / totalImplied) - 1) * 100;
          profitAmount = totalInvestment * profitPercentage / 100;
        }
      }
      
      elements.profitPercentage.textContent = profitPercentage.toFixed(2) + '%';
      elements.profitAmount.textContent = profitAmount.toFixed(2);
    }

    // Event Listeners para inputs
    elements.odd1.addEventListener('input', calculateStakes);
    elements.odd2.addEventListener('input', calculateStakes);
    
    elements.stake1.addEventListener('input', () => {
      handleStakeInput(
        elements.stake1,
        elements.stake2,
        parseFloat(elements.odd1.value),
        parseFloat(elements.odd2.value)
      );
    });

    elements.stake2.addEventListener('input', () => {
      handleStakeInput(
        elements.stake2,
        elements.stake1,
        parseFloat(elements.odd2.value),
        parseFloat(elements.odd1.value)
      );
    });

    // FunÃ§Ã£o para carregar o histÃ³rico de apostas (com listener em tempo real)
    function loadBetHistory(uid) {
      const betsRef = collection(db, 'bets');
      const q = query(betsRef, where('uid', '==', uid));
      
      // Usando onSnapshot para atualizaÃ§Ãµes em tempo real
      onSnapshot(q, (querySnapshot) => {
        const tbody = document.querySelector('#bet-history-table tbody');
        tbody.innerHTML = ""; // Limpa linhas anteriores
        
        querySnapshot.forEach(doc => {
          const data = doc.data();
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${new Date(data.timestamp).toLocaleString()}</td>
            <td>${data.odd1.toFixed(2)}</td>
            <td>${data.odd2.toFixed(2)}</td>
            <td>${data.stake1.toFixed(2)}</td>
            <td>${data.stake2.toFixed(2)}</td>
            <td>${data.total.toFixed(2)}</td>
            <td>${data.lucro.toFixed(2)}</td>
            <td>${data.roi.toFixed(2)}%</td>
          `;
          tbody.appendChild(row);
        });
      });
    }

    // FunÃ§Ã£o para exportar a tabela para CSV
    function exportTableToCSV(filename) {
      const csv = [];
      const rows = document.querySelectorAll("#bet-history-table tr");

      for (let row of rows) {
        const cols = row.querySelectorAll("td, th");
        const rowData = [];
        for (let col of cols) {
          rowData.push('"' + col.innerText.replace(/"/g, '""') + '"'); // Escapa aspas
        }
        csv.push(rowData.join(","));
      }

      const csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
      const downloadLink = document.createElement("a");
      downloadLink.download = filename;
      downloadLink.href = window.URL.createObjectURL(csvFile);
      downloadLink.style.display = "none";
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
    }

    document.getElementById('export-csv').addEventListener('click', () => {
      exportTableToCSV('historico_apostas.csv');
    });

    // FunÃ§Ã£o para salvar a aposta
    elements.saveButton.addEventListener('click', async () => {
      if (!currentUser) {
        elements.errorMessage.textContent = "Por favor, realize o login com o Google antes de salvar a aposta.";
        elements.errorMessage.style.display = 'block';
        return;
      }
      
      elements.loading.style.display = 'block';
      elements.errorMessage.style.display = 'none';
      
      try {
        const betData = {
          uid: currentUser.uid,
          odd1: parseFloat(elements.odd1.value),
          odd2: parseFloat(elements.odd2.value),
          stake1: parseFloat(elements.stake1.value),
          stake2: parseFloat(elements.stake2.value),
          total: parseFloat(elements.totalInvested.textContent),
          lucro: parseFloat(elements.profitAmount.textContent),
          roi: parseFloat(elements.profitPercentage.textContent.replace('%', '')),
          timestamp: new Date().toISOString()
        };

        await addDoc(collection(db, 'bets'), betData);
        
        elements.successMessage.style.display = 'block';
        setTimeout(() => {
          elements.successMessage.style.display = 'none';
        }, 3000);

        // O histÃ³rico serÃ¡ atualizado automaticamente via onSnapshot.
      } catch (error) {
        console.error('Erro detalhado:', error);
        elements.errorMessage.textContent = `Erro: ${error.message}`;
        elements.errorMessage.style.display = 'block';
      } finally {
        elements.loading.style.display = 'none';
      }
    });

    // Configurar o Login com Google (caso o usuÃ¡rio clique manualmente)
    elements.googleLoginButton.addEventListener('click', async () => {
      try {
        const result = await signInWithPopup(auth, provider);
        // O observador onAuthStateChanged cuidarÃ¡ do restante
      } catch (error) {
        console.error('Erro no login com Google:', error);
        elements.errorMessage.textContent = `Erro no login: ${error.message}`;
        elements.errorMessage.style.display = 'block';
      }
    });

    // Inicializa os cÃ¡lculos
    calculateProfit();
  </script>
</body>
</html>
