<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculadora Surebet - Debug</title>
  <style>
    /* EstilizaÃ§Ã£o omitida para brevidade... mantenha a mesma CSS que vocÃª jÃ¡ tinha */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }
    /* ... resto do CSS igual ao anterior */
  </style>
</head>
<body>
  <div id="user-info" style="display:none;">
    <span id="user-name"></span>
    <button id="sign-out">Sair</button>
  </div>

  <div class="container" id="calculator-container">
    <h2>ðŸ“Š Calculadora Surebet (Debug)</h2>
    <div class="actions">
      <button id="google-login">Login com Google</button>
    </div>
    
    <div id="error-message"></div>

    <div class="input-group">
      <div class="input-container">
        <label for="odd1">Odd 1</label>
        <input type="number" step="0.01" id="odd1" placeholder="Ex: 1.80">
      </div>
      <div class="input-container">
        <label for="odd2">Odd 2</label>
        <input type="number" step="0.01" id="odd2" placeholder="Ex: 2.20">
      </div>
    </div>

    <div class="input-group">
      <div class="input-container">
        <label for="stake1">Valor Aposta 1</label>
        <input type="number" step="0.01" id="stake1" placeholder="0.00">
      </div>
      <div class="input-container">
        <label for="stake2">Valor Aposta 2</label>
        <input type="number" step="0.01" id="stake2" placeholder="0.00">
      </div>
    </div>

    <div class="input-group">
      <div class="input-container">
        <label for="bookmaker">Casa de Aposta</label>
        <input type="text" id="bookmaker" placeholder="Ex: Bet365">
      </div>
    </div>

    <div class="results">
      <div class="result-item" id="total-invested">
        Total Investido: <span>0.00</span>
      </div>
      <div class="result-item">
        Lucro Garantido: <span id="profit-amount">0.00</span>
      </div>
      <div class="result-item">
        ROI (%): <span id="profit-percentage">0.00%</span>
      </div>
    </div>

    <div class="actions">
      <button id="save-bet">Salvar Aposta</button>
      <div id="loading" class="loading">Salvando...</div>
      <div id="success-message">âœ” Aposta registrada com sucesso!</div>
    </div>
  </div>

  <div class="history" id="history-section" style="display: none;">
    <h3>HistÃ³rico de Apostas</h3>
    <div class="actions">
      <select id="date-filter">
        <option value="all">Todos</option>
        <option value="24h">Ãšltimas 24 horas</option>
        <option value="48h">Ãšltimas 48 horas</option>
        <option value="7d">Ãšltimos 7 dias</option>
        <option value="30d">Ãšltimos 30 dias</option>
      </select>
    </div>
    <table id="bet-history-table">
      <thead>
        <tr>
          <th>Data/Hora</th>
          <th>Casa de Aposta</th>
          <th>Odd 1</th>
          <th>Odd 2</th>
          <th>Stake 1</th>
          <th>Stake 2</th>
          <th>Total Investido</th>
          <th>Lucro</th>
          <th>ROI (%)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="actions">
      <button id="export-csv">Exportar CSV</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      addDoc,
      query,
      where,
      onSnapshot,
      orderBy
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { 
      getAuth, 
      signInWithPopup, 
      GoogleAuthProvider,
      onAuthStateChanged,
      setPersistence,
      browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // CONFIG DO FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyCKEdVxlZ7QZCKzwMWwTjvJw6gkWBPU1Ks",
      authDomain: "surebet-8alac.firebaseapp.com",
      projectId: "surebet-8alac",
      storageBucket: "surebet-8alac.appspot.com",
      messagingSenderId: "356453418095",
      appId: "1:356453418095:web:b5fa12af09432b9676b99a"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    await setPersistence(auth, browserLocalPersistence);

    // REFERÃŠNCIAS
    const elements = {
      odd1: document.getElementById('odd1'),
      odd2: document.getElementById('odd2'),
      stake1: document.getElementById('stake1'),
      stake2: document.getElementById('stake2'),
      totalInvested: document.querySelector('#total-invested span'),
      profitPercentage: document.getElementById('profit-percentage'),
      profitAmount: document.getElementById('profit-amount'),
      saveButton: document.getElementById('save-bet'),
      loading: document.getElementById('loading'),
      errorMessage: document.getElementById('error-message'),
      successMessage: document.getElementById('success-message'),
      googleLoginButton: document.getElementById('google-login'),
      bookmaker: document.getElementById('bookmaker'),
      dateFilter: document.getElementById('date-filter')
    };
    const userInfo = document.getElementById('user-info');
    const userName = document.getElementById('user-name');
    const signOutButton = document.getElementById('sign-out');
    const historySection = document.getElementById('history-section');
    let currentUser = null;
    let unsubscribeHistory = null;

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        console.log('UsuÃ¡rio autenticado:', currentUser.displayName);
        userName.textContent = currentUser.displayName || "UsuÃ¡rio";
        userInfo.style.display = 'block';
        elements.googleLoginButton.style.display = 'none';
        historySection.style.display = 'block';
        loadBetHistory(currentUser.uid, 'all');
      } else {
        currentUser = null;
        userInfo.style.display = 'none';
        elements.googleLoginButton.style.display = 'block';
        historySection.style.display = 'none';
      }
    });

    signOutButton.addEventListener('click', async () => {
      try {
        await auth.signOut();
        console.log("UsuÃ¡rio saiu com sucesso!");
      } catch (error) {
        console.error("Erro ao sair:", error);
      }
    });

    function calculateProfit() {
      const o1 = parseFloat(elements.odd1.value);
      const o2 = parseFloat(elements.odd2.value);
      const s1 = parseFloat(elements.stake1.value) || 0;
      const s2 = parseFloat(elements.stake2.value) || 0;
      const totalInvestment = s1 + s2;
      elements.totalInvested.textContent = totalInvestment.toFixed(2);

      let profitPct = 0;
      let profitAmt = 0;
      if (o1 > 0 && o2 > 0) {
        const totalImpl = (1 / o1 + 1 / o2);
        if (totalImpl < 1) {
          profitPct = ((1 / totalImpl) - 1) * 100;
          profitAmt = totalInvestment * (profitPct / 100);
        }
      }
      elements.profitPercentage.textContent = profitPct.toFixed(2) + '%';
      elements.profitAmount.textContent = profitAmt.toFixed(2);
    }

    function calculateStakes() {
      const o1 = parseFloat(elements.odd1.value);
      const o2 = parseFloat(elements.odd2.value);
      if (o1 > 0 && o2 > 0) {
        const total = parseFloat(elements.stake1.value) + parseFloat(elements.stake2.value);
        if (total > 0) {
          elements.stake1.value = ((total * o2) / (o1 + o2)).toFixed(2);
          elements.stake2.value = ((total * o1) / (o1 + o2)).toFixed(2);
        }
      }
      calculateProfit();
    }

    elements.odd1.addEventListener('input', calculateStakes);
    elements.odd2.addEventListener('input', calculateStakes);

    elements.stake1.addEventListener('input', () => {
      handleStakeInput(elements.stake1, elements.stake2,
        parseFloat(elements.odd1.value),
        parseFloat(elements.odd2.value)
      );
    });
    elements.stake2.addEventListener('input', () => {
      handleStakeInput(elements.stake2, elements.stake1,
        parseFloat(elements.odd2.value),
        parseFloat(elements.odd1.value)
      );
    });

    function handleStakeInput(inputEl, otherEl, oddI, oddO) {
      const val = parseFloat(inputEl.value);
      if (oddI > 0 && oddO > 0 && !isNaN(val)) {
        otherEl.value = ((val * oddI) / oddO).toFixed(2);
      }
      calculateProfit();
    }

    function loadBetHistory(uid, filter) {
      if (unsubscribeHistory) {
        unsubscribeHistory();
      }
      const betsRef = collection(db, 'bets');
      let betsQuery = query(
        betsRef,
        where('uid','==',uid),
        orderBy('timestamp','desc')
      );

      if (filter !== 'all') {
        const now = new Date();
        const startDate = new Date();
        if (filter === '24h') {
          startDate.setHours(now.getHours() - 24);
        } else if (filter === '48h') {
          startDate.setHours(now.getHours() - 48);
        } else if (filter === '7d') {
          startDate.setDate(now.getDate() - 7);
        } else if (filter === '30d') {
          startDate.setDate(now.getDate() - 30);
        }
        betsQuery = query(
          betsRef,
          where('uid','==',uid),
          where('timestamp','>=',startDate.toISOString()),
          orderBy('timestamp','desc')
        );
      }

      console.log("Iniciando onSnapshot para histÃ³rico...");
      unsubscribeHistory = onSnapshot(betsQuery, (qsnap) => {
        console.log("HistÃ³rico atualizado. Tamanho:", qsnap.size);
        const tbody = document.querySelector('#bet-history-table tbody');
        tbody.innerHTML = "";
        qsnap.forEach(doc => {
          const data = doc.data();
          console.log("DOC:", doc.id, data);

          // Converte string ISO para Date
          const dateObj = new Date(data.timestamp);
          const dateStr = dateObj.toLocaleString("pt-BR", { timeZone: "America/Sao_Paulo" });

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${dateStr}</td>
            <td>${data.bookmaker || ''}</td>
            <td>${data.odd1.toFixed(2)}</td>
            <td>${data.odd2.toFixed(2)}</td>
            <td>${data.stake1.toFixed(2)}</td>
            <td>${data.stake2.toFixed(2)}</td>
            <td>${data.total.toFixed(2)}</td>
            <td>${data.lucro.toFixed(2)}</td>
            <td>${data.roi.toFixed(2)}%</td>
          `;
          tbody.appendChild(row);
        });
      }, (error) => {
        console.error("Erro ao ler histÃ³rico:", error);
      });
    }

    elements.dateFilter.addEventListener('change', (e) => {
      const sel = e.target.value;
      if (currentUser) {
        loadBetHistory(currentUser.uid, sel);
      }
    });

    document.getElementById('export-csv').addEventListener('click', () => {
      exportTableToCSV('historico_apostas.csv');
    });
    function exportTableToCSV(filename) {
      const csv = [];
      const rows = document.querySelectorAll("#bet-history-table tr");
      rows.forEach(row => {
        const cols = row.querySelectorAll("td, th");
        const rowData = [];
        cols.forEach(col => {
          rowData.push('"' + col.innerText.replace(/"/g, '""') + '"');
        });
        csv.push(rowData.join(","));
      });
      const csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
      const link = document.createElement("a");
      link.download = filename;
      link.href = window.URL.createObjectURL(csvFile);
      link.style.display = "none";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // SALVAR APOSTA
    elements.saveButton.addEventListener('click', async () => {
      if (!currentUser) {
        elements.errorMessage.textContent = "Por favor, faÃ§a login antes de salvar a aposta.";
        elements.errorMessage.style.display = 'block';
        return;
      }
      elements.loading.style.display = 'block';
      elements.errorMessage.style.display = 'none';
      console.log("Iniciando processo de salvar aposta...");
      try {
        const nowISO = new Date().toISOString();
        const betData = {
          uid: currentUser.uid,
          odd1: parseFloat(elements.odd1.value),
          odd2: parseFloat(elements.odd2.value),
          stake1: parseFloat(elements.stake1.value),
          stake2: parseFloat(elements.stake2.value),
          total: parseFloat(elements.totalInvested.textContent),
          lucro: parseFloat(elements.profitAmount.textContent),
          roi: parseFloat(elements.profitPercentage.textContent.replace('%','')),
          bookmaker: elements.bookmaker.value || "",
          timestamp: nowISO
        };
        console.log("Salvar =>", betData);

        // Tenta gravar no Firestore
        const docRef = await addDoc(collection(db, 'bets'), betData);
        console.log("Aposta salva com sucesso! docId=", docRef.id);

        elements.successMessage.style.display = 'block';
        setTimeout(() => { elements.successMessage.style.display = 'none'; }, 3000);

      } catch (error) {
        console.error("ERRO NO SALVAR APOSTA =>", error);
        elements.errorMessage.textContent = `Erro: ${error.message}`;
        elements.errorMessage.style.display = 'block';
      } finally {
        console.log("Finalizando processo de salvar aposta...");
        elements.loading.style.display = 'none';
      }
    });

    // LOGIN COM GOOGLE
    elements.googleLoginButton.addEventListener('click', async () => {
      console.log("Tentando login com Google...");
      try {
        await signInWithPopup(auth, provider);
        console.log("Login Google bem-sucedido!");
      } catch (err) {
        console.error("Erro no login Google:", err);
        elements.errorMessage.textContent = `Erro no login: ${err.message}`;
        elements.errorMessage.style.display = 'block';
      }
    });

    // Inicia com ROI zerado
    calculateProfit();
  </script>
</body>
</html>
