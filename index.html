<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculadora Surebet Profissional</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      min-height: 100vh;
    }
    /* Cabe√ßalho para informa√ß√µes do usu√°rio */
    #user-info {
      text-align: right;
      margin-bottom: 20px;
      display: none;
    }
    #user-info span {
      font-weight: bold;
      margin-right: 10px;
    }
    #user-info button {
      padding: 5px 10px;
      font-size: 0.9em;
      background: #e74c3c;
      border: none;
      color: #fff;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    #user-info button:hover {
      background: #c0392b;
    }
    /* Container principal com layout original */
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      margin-bottom: 30px;
    }
    h2, h3 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .input-group {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    .input-container {
      flex: 1;
      position: relative;
      min-width: 250px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      color: #34495e;
      font-weight: 600;
      font-size: 0.95em;
    }
    input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
      background: #f8f9fa;
    }
    input:focus {
      outline: none;
      border-color: #3498db;
      background: white;
      box-shadow: 0 0 8px rgba(52, 152, 219, 0.2);
    }
    .results {
      margin-top: 25px;
      padding: 20px;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    .result-item {
      margin: 15px 0;
      font-size: 1.1em;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid #eee;
    }
    .result-item:last-child {
      border-bottom: none;
    }
    .result-item span {
      font-weight: 700;
      font-size: 1.2em;
    }
    #total-invested span { color: #2980b9; }
    #profit-amount { color: #27ae60; }
    #profit-percentage { color: #e67e22; }
    .actions {
      margin-top: 25px;
      text-align: center;
    }
    button {
      background: #3498db;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      transition: all 0.3s ease;
      margin-top: 20px;
    }
    button:hover {
      background: #2980b9;
      transform: translateY(-1px);
    }
    .loading {
      display: none;
      text-align: center;
      color: #3498db;
      margin: 15px 0;
    }
    #error-message {
      color: #e74c3c;
      background: #f8d7da;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      display: none;
    }
    #success-message {
      color: #27ae60;
      margin-top: 15px;
      display: none;
    }
    .currency {
      position: absolute;
      right: 15px;
      top: 38px;
      color: #7f8c8d;
      font-weight: 500;
    }
    /* Se√ß√£o de Hist√≥rico com o mesmo estilo do container principal */
    .history {
      max-width: 600px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      overflow-x: auto;  /* Permite rolagem horizontal se necess√°rio */
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
      min-width: 700px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 10px;
      text-align: center;
    }
    th {
      background: #3498db;
      color: #fff;
    }
    /* Estiliza o seletor de filtros */
    #date-filter {
      margin-bottom: 15px;
      padding: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <!-- Cabe√ßalho com informa√ß√µes do usu√°rio -->
  <div id="user-info">
    <span id="user-name"></span>
    <button id="sign-out">Sair</button>
  </div>

  <!-- Container da Calculadora e Login -->
  <div class="container" id="calculator-container">
    <h2>üìä Calculadora Surebet</h2>
    
    <!-- Bot√£o de Login com Google -->
    <div class="actions">
      <button id="google-login">Login com Google</button>
    </div>
    
    <div id="error-message"></div>

    <div class="input-group">
      <div class="input-container">
        <label for="odd1">Odd 1</label>
        <input type="number" step="0.01" id="odd1" placeholder="Ex: 1.80">
      </div>
      <div class="input-container">
        <label for="odd2">Odd 2</label>
        <input type="number" step="0.01" id="odd2" placeholder="Ex: 2.20">
      </div>
    </div>

    <div class="input-group">
      <div class="input-container">
        <label for="stake1">Valor Aposta 1</label>
        <div class="currency">R$</div>
        <input type="number" step="0.01" id="stake1" placeholder="0.00">
      </div>
      <div class="input-container">
        <label for="stake2">Valor Aposta 2</label>
        <div class="currency">R$</div>
        <input type="number" step="0.01" id="stake2" placeholder="0.00">
      </div>
    </div>

    <!-- Campo para informar a casa de aposta -->
    <div class="input-group">
      <div class="input-container">
        <label for="bookmaker">Casa de Aposta</label>
        <input type="text" id="bookmaker" placeholder="Ex: Bet365">
      </div>
    </div>

    <div class="results">
      <div class="result-item" id="total-invested">
        Total Investido: <span>0.00</span>
      </div>
      <div class="result-item">
        Lucro Garantido: <span id="profit-amount">0.00</span>
      </div>
      <div class="result-item">
        ROI (%): <span id="profit-percentage">0.00%</span>
      </div>
    </div>

    <div class="actions">
      <button id="save-bet">Salvar Aposta</button>
      <div id="loading" class="loading">Salvando...</div>
      <div id="success-message">‚úî Aposta registrada com sucesso!</div>
    </div>
  </div>

  <!-- Se√ß√£o de Hist√≥rico de Apostas -->
  <div class="history" id="history-section" style="display: none;">
    <h3>Hist√≥rico de Apostas</h3>

    <!-- Filtro de datas (24h, 48h, 7 dias, 30 dias, ou todos) -->
    <div class="actions">
      <select id="date-filter">
        <option value="all">Todos</option>
        <option value="24h">√öltimas 24 horas</option>
        <option value="48h">√öltimas 48 horas</option>
        <option value="7d">√öltimos 7 dias</option>
        <option value="30d">√öltimos 30 dias</option>
      </select>
    </div>

    <table id="bet-history-table">
      <thead>
        <tr>
          <th>Data</th>
          <th>Casa de Aposta</th>
          <th>Odd 1</th>
          <th>Odd 2</th>
          <th>Stake 1</th>
          <th>Stake 2</th>
          <th>Total Investido</th>
          <th>Lucro</th>
          <th>ROI (%)</th>
        </tr>
      </thead>
      <tbody>
        <!-- Linhas geradas dinamicamente -->
      </tbody>
    </table>
    <div class="actions">
      <button id="export-csv">Exportar CSV</button>
    </div>
  </div>

  <!-- Script com integra√ß√£o Firebase, login, c√°lculos, hist√≥rico e exporta√ß√£o CSV -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      addDoc,
      query,
      where,
      onSnapshot,
      orderBy
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { 
      getAuth, 
      signInWithPopup, 
      GoogleAuthProvider,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // Configura√ß√£o do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCKEdVxlZ7QZCKzwMWwTjvJw6gkWBPU1Ks",
      authDomain: "surebet-8a1ac.firebaseapp.com",
      projectId: "surebet-8a1ac",
      storageBucket: "surebet-8a1ac.firebasestorage.app",
      messagingSenderId: "356453418095",
      appId: "1:356453418095:web:b5fa12af09432b9676b99a",
      measurementId: "G-WYX4MDS2F8"
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    // Refer√™ncias dos elementos
    const elements = {
      odd1: document.getElementById('odd1'),
      odd2: document.getElementById('odd2'),
      stake1: document.getElementById('stake1'),
      stake2: document.getElementById('stake2'),
      totalInvested: document.querySelector('#total-invested span'),
      profitPercentage: document.getElementById('profit-percentage'),
      profitAmount: document.getElementById('profit-amount'),
      saveButton: document.getElementById('save-bet'),
      loading: document.getElementById('loading'),
      errorMessage: document.getElementById('error-message'),
      successMessage: document.getElementById('success-message'),
      googleLoginButton: document.getElementById('google-login'),
      bookmaker: document.getElementById('bookmaker'),
      dateFilter: document.getElementById('date-filter')
    };
    const userInfo = document.getElementById('user-info');
    const userName = document.getElementById('user-name');
    const signOutButton = document.getElementById('sign-out');
    const historySection = document.getElementById('history-section');

    let currentUser = null;
    let unsubscribeHistory = null; // Para remover o listener anterior ao mudar o filtro

    // Observador de autentica√ß√£o
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        console.log('Usu√°rio autenticado:', currentUser.displayName);
        userName.textContent = currentUser.displayName || "Usu√°rio";
        userInfo.style.display = 'block';
        elements.googleLoginButton.style.display = 'none';
        historySection.style.display = 'block';
        // Carrega hist√≥rico inicial (sem filtros => 'all')
        loadBetHistory(currentUser.uid, 'all');
      } else {
        currentUser = null;
        userInfo.style.display = 'none';
        elements.googleLoginButton.style.display = 'block';
        historySection.style.display = 'none';
      }
    });

    // Fun√ß√£o de logout
    signOutButton.addEventListener('click', async () => {
      try {
        await auth.signOut();
        console.log("Usu√°rio saiu com sucesso!");
      } catch (error) {
        console.error("Erro ao sair:", error);
      }
    });

    // ------------------------------
    // C√ÅLCULOS DE SUREBET
    // ------------------------------
    function calculateProfit() {
      const o1 = parseFloat(elements.odd1.value);
      const o2 = parseFloat(elements.odd2.value);
      const s1 = parseFloat(elements.stake1.value) || 0;
      const s2 = parseFloat(elements.stake2.value) || 0;

      const totalInvestment = s1 + s2;
      elements.totalInvested.textContent = totalInvestment.toFixed(2);

      let profitPercentage = 0;
      let profitAmount = 0;
      if (o1 > 0 && o2 > 0) {
        const totalImplied = (1 / o1 + 1 / o2);
        if (totalImplied < 1) {
          profitPercentage = ((1 / totalImplied) - 1) * 100;
          profitAmount = totalInvestment * (profitPercentage / 100);
        }
      }
      elements.profitPercentage.textContent = profitPercentage.toFixed(2) + '%';
      elements.profitAmount.textContent = profitAmount.toFixed(2);
    }

    // Recalcula ambas stakes quando se edita a odd
    function calculateStakes() {
      const o1 = parseFloat(elements.odd1.value);
      const o2 = parseFloat(elements.odd2.value);
      if (o1 > 0 && o2 > 0) {
        const total = parseFloat(elements.stake1.value) + parseFloat(elements.stake2.value);
        if (total > 0) {
          // Ajusta stake1 e stake2 proporcionalmente √†s odds
          elements.stake1.value = ((total * o2) / (o1 + o2)).toFixed(2);
          elements.stake2.value = ((total * o1) / (o1 + o2)).toFixed(2);
        }
      }
      calculateProfit();
    }

    // Quando edita manualmente Stake1 ou Stake2, recalcula a outra
    function handleStakeInput(inputElement, otherElement, oddForInput, oddForOther) {
      const value = parseFloat(inputElement.value);
      if (oddForInput > 0 && oddForOther > 0 && !isNaN(value)) {
        otherElement.value = ((value * oddForInput) / oddForOther).toFixed(2);
      }
      calculateProfit();
    }

    // Listeners
    elements.odd1.addEventListener('input', calculateStakes);
    elements.odd2.addEventListener('input', calculateStakes);

    elements.stake1.addEventListener('input', () => {
      // Se digita na stake1, stake2 √© recalculada
      handleStakeInput(elements.stake1, elements.stake2,
                       parseFloat(elements.odd1.value),
                       parseFloat(elements.odd2.value));
    });
    elements.stake2.addEventListener('input', () => {
      // Se digita na stake2, stake1 √© recalculada
      handleStakeInput(elements.stake2, elements.stake1,
                       parseFloat(elements.odd2.value),
                       parseFloat(elements.odd1.value));
    });

    // ------------------------------
    // CARREGAR HIST√ìRICO (FILTROS)
    // ------------------------------
    function loadBetHistory(uid, filter) {
      // Se j√° houver um listener aberto, paramos.
      if (unsubscribeHistory) {
        unsubscribeHistory();
      }
      const betsRef = collection(db, 'bets');

      // Monta uma query inicial para "Todos"
      let betsQuery = query(
        betsRef,
        where('uid', '==', uid),
        orderBy('timestamp', 'desc')
      );

      // Se o filtro n√£o for "all", ajusta para buscar a data m√≠nima
      if (filter !== 'all') {
        const now = new Date();
        const startDate = new Date();

        if (filter === '24h') {
          startDate.setHours(now.getHours() - 24);
        } else if (filter === '48h') {
          startDate.setHours(now.getHours() - 48);
        } else if (filter === '7d') {
          startDate.setDate(now.getDate() - 7);
        } else if (filter === '30d') {
          startDate.setDate(now.getDate() - 30);
        }
        const isoStart = startDate.toISOString();

        // Recria a query com where('timestamp','>=', isoStart)
        // Observa√ß√£o: Isto funciona se 'timestamp' for guardado como string (ex: .toISOString()).
        // Se antes voc√™ salvou como Timestamp do Firestore, ajustamos abaixo na convers√£o.
        betsQuery = query(
          betsRef,
          where('uid', '==', uid),
          where('timestamp', '>=', isoStart),
          orderBy('timestamp', 'desc')
        );
      }

      unsubscribeHistory = onSnapshot(betsQuery, (querySnapshot) => {
        const tbody = document.querySelector('#bet-history-table tbody');
        tbody.innerHTML = "";
        querySnapshot.forEach(doc => {
          const data = doc.data();

          // Tenta converter o campo timestamp em Data local
          let dateObj;
          if (!data.timestamp) {
            // Se n√£o existir timestamp, pula ou defina um default
            return;
          } else if (typeof data.timestamp.toDate === 'function') {
            // Caso seja um Firestore Timestamp
            dateObj = data.timestamp.toDate();
          } else if (typeof data.timestamp === 'number') {
            // Caso tenha sido salvo como n√∫mero (ex: Date.now())
            dateObj = new Date(data.timestamp);
          } else {
            // Supondo string em formato ISO
            dateObj = new Date(data.timestamp);
          }

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${dateObj.toLocaleString()}</td>
            <td>${data.bookmaker || ''}</td>
            <td>${data.odd1.toFixed(2)}</td>
            <td>${data.odd2.toFixed(2)}</td>
            <td>${data.stake1.toFixed(2)}</td>
            <td>${data.stake2.toFixed(2)}</td>
            <td>${data.total.toFixed(2)}</td>
            <td>${data.lucro.toFixed(2)}</td>
            <td>${data.roi.toFixed(2)}%</td>
          `;
          tbody.appendChild(row);
        });
      }, (error) => {
        console.error("Erro ao carregar hist√≥rico:", error);
      });
    }

    // Ao mudar o filtro no select, recarrega o hist√≥rico
    elements.dateFilter.addEventListener('change', (event) => {
      const selectedFilter = event.target.value;
      if (currentUser) {
        loadBetHistory(currentUser.uid, selectedFilter);
      }
    });

    // ------------------------------
    // EXPORTAR CSV
    // ------------------------------
    function exportTableToCSV(filename) {
      const csv = [];
      const rows = document.querySelectorAll("#bet-history-table tr");
      rows.forEach(row => {
        const cols = row.querySelectorAll("td, th");
        const rowData = [];
        cols.forEach(col => {
          // Garante que aspas n√£o quebrem o CSV
          rowData.push('"'+ col.innerText.replace(/"/g, '""') +'"');
        });
        csv.push(rowData.join(","));
      });
      const csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
      const downloadLink = document.createElement("a");
      downloadLink.download = filename;
      downloadLink.href = window.URL.createObjectURL(csvFile);
      downloadLink.style.display = "none";
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
    }
    document.getElementById('export-csv').addEventListener('click', () => {
      exportTableToCSV('historico_apostas.csv');
    });

    // ------------------------------
    // SALVAR APOSTA NO FIRESTORE
    // ------------------------------
    elements.saveButton.addEventListener('click', async () => {
      if (!currentUser) {
        elements.errorMessage.textContent = "Por favor, realize o login com o Google antes de salvar a aposta.";
        elements.errorMessage.style.display = 'block';
        return;
      }
      elements.loading.style.display = 'block';
      elements.errorMessage.style.display = 'none';
      try {
        const betData = {
          uid: currentUser.uid,
          odd1: parseFloat(elements.odd1.value),
          odd2: parseFloat(elements.odd2.value),
          stake1: parseFloat(elements.stake1.value),
          stake2: parseFloat(elements.stake2.value),
          total: parseFloat(elements.totalInvested.textContent),
          lucro: parseFloat(elements.profitAmount.textContent),
          roi: parseFloat(elements.profitPercentage.textContent.replace('%', '')),
          bookmaker: elements.bookmaker.value || "",
          // Aqui salvamos como string ISO. Voc√™ pode salvar como Timestamp do Firestore tamb√©m.
          timestamp: new Date().toISOString()
        };
        console.log("Salvando aposta:", betData);
        await addDoc(collection(db, 'bets'), betData);
        console.log("Aposta salva com sucesso!");
        elements.successMessage.style.display = 'block';
        setTimeout(() => {
          elements.successMessage.style.display = 'none';
        }, 3000);
      } catch (error) {
        console.error('Erro ao salvar aposta:', error);
        elements.errorMessage.textContent = `Erro: ${error.message}`;
        elements.errorMessage.style.display = 'block';
      } finally {
        elements.loading.style.display = 'none';
      }
    });

    // ------------------------------
    // LOGIN COM GOOGLE
    // ------------------------------
    elements.googleLoginButton.addEventListener('click', async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (error) {
        console.error('Erro no login com Google:', error);
        elements.errorMessage.textContent = `Erro no login: ${error.message}`;
        elements.errorMessage.style.display = 'block';
      }
    });

    // Inicializa os valores de ROI e lucro como 0
    calculateProfit();
  </script>
</body>
</html>
